#!/usr/bin/env php
<?php
require __DIR__ . '/../vendor/autoload.php';

use Icecave\Overpass\Amqp\AmqpDeclarationManager;
use Icecave\Overpass\Amqp\PubSub\AmqpPublisher;
use Icecave\Overpass\Serialization\JsonSerialization;

$connection = new AMQPConnection(
    [
        'host' => 'localhost',
        'port' => 5672,
        'read_timeout' => 3,
        'write_timeout' => 3,
    ]
);

$connection->connect();

$topic = isset($_SERVER['argv'][1])
        ? $_SERVER['argv'][1]
        : '';

$publisher = new AmqpPublisher(
    $connection,
    new AmqpDeclarationManager,
    new JsonSerialization
);

$payloadCounter = 0;
$delta = 1;
$perSecond = 1;
$maxPerSecond = 100;

while (true) {

    $start = microtime(true);
    for ($i = 0; $i < $perSecond; ++$i) {
        $publisher->publish($topic, $payloadCounter++);
    }
    $elapsed = microtime(true) - $start;

    $percentage = ($perSecond / $maxPerSecond) * 100;
    echo str_repeat('*', $percentage) . PHP_EOL;

    usleep(1000000 - $elapsed);

    $perSecond += $delta;

    if ($perSecond === $maxPerSecond || $perSecond === 1) {
        $delta *= -1;
    }
}
