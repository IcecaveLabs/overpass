#!/usr/bin/env php
<?php
require __DIR__ . '/../vendor/autoload.php';

use Icecave\Overpass\Amqp\AmqpDeclarationManager;
use Icecave\Overpass\Amqp\PubSub\AmqpPublisher;
use Icecave\Overpass\Serialization\JsonSerialization;
use PhpAmqpLib\Connection\AMQPStreamConnection;

$connection = new AMQPStreamConnection(
    'localhost',
    5672,
    'guest',
    'guest',
    '/'
);

$topic = isset($_SERVER['argv'][1])
        ? $_SERVER['argv'][1]
        : '';

$publisher = new AmqpPublisher(
    $connection->channel(),
    new AmqpDeclarationManager,
    new JsonSerialization
);

$payloadCounter = 1;
$sleep = 1000000;

while (true) {
    $publisher->publish($topic, $payloadCounter++);

    echo '.';

    usleep($sleep);
}
