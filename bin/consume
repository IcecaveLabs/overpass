#!/usr/bin/env php
<?php
require __DIR__ . '/../vendor/autoload.php';

use PhpAmqpLib\Connection\AMQPStreamConnection;
use Icecave\Overpass\Amqp\AmqpDeclarationManager;
use Icecave\Overpass\Amqp\PubSub\AmqpSubscriber;
use Icecave\Overpass\Serialization\JsonSerialization;

$connection = new AMQPStreamConnection(
    'localhost',
    5672,
    'guest',
    'guest',
    '/'
);

$subscriber = new AmqpSubscriber(
    $connection->channel(),
    new AmqpDeclarationManager,
    new JsonSerialization
);

$subscriber->subscribe(
    isset($_SERVER['argv'][1])
        ? $_SERVER['argv'][1]
        : '*'
);

$subscriber->consume(
    function ($topic, $payload) {
        printf('<== %s %s' . PHP_EOL, $topic, $payload);

        return true;
    }
);
