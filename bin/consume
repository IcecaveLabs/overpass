#!/usr/bin/env php
<?php
require __DIR__ . '/../vendor/autoload.php';

use Icecave\Overpass\Amqp\AmqpPubSubClient;

while (true) {
    try {
        $connection = new AMQPConnection(
            [
                'host' => 'localhost',
                'port' => 5672,
                'read_timeout' => 5,
                'write_timeout' => 5,
                'connect_timeout' => 3,
            ]
        );

        echo 'Connecting...';
        $connection->connect();
        echo 'Done.' . PHP_EOL;

        $pubSub = new AmqpPubSubClient($connection);
        $pubSub->subscribe(
            isset($_SERVER['argv'][1])
                ? $_SERVER['argv'][1]
                : '*'
        );

        $pubSub->consume(
            function ($topic, $payload) {
                printf('%-10s %s' . PHP_EOL, $topic, $payload);

                return true;
            }
        );

        break;
    } catch (AMQPConnectionException $e) {
        echo $e->getMessage() . PHP_EOL;
        sleep(1);

        continue;
    }
}
