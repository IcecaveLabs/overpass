#!/usr/bin/env php
<?php
require __DIR__ . '/../vendor/autoload.php';

use Eloquent\Asplode\Asplode;
use Icecave\Overpass\Amqp\Rpc\AmqpRpcServer;
use Icecave\Overpass\Rpc\Registry;
use PhpAmqpLib\Connection\AMQPStreamConnection;

Asplode::install();

$connection = new AMQPStreamConnection(
    'localhost',
    5672,
    'guest',
    'guest',
    '/'
);

$registry = new Registry;

$registry->register(
    'double',
    function ($value) {
        printf('[server] <== double(%d)' . PHP_EOL, $value);
        $result = $value * 2;
        printf('[server] ==> %d' . PHP_EOL, $result);

        return $result;
    }
);

$server = new AmqpRpcServer(
    $registry,
    $connection->channel()
);

$server->run();
