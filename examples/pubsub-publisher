#!/usr/bin/env php
<?php
// Initialize the AMQP connection, logger, etc.
require __DIR__ . '/common.php';

// Parse the command line parameters ...
list(, $sleep, $topic) = $_SERVER['argv'] + [
    null,
    1,               // sleep
    'default-topic', // topic
];

// Create an Overpass publisher ...
$publisher = new Icecave\Overpass\Amqp\PubSub\AmqpPublisher(
    $amqpChannel
);

$publisher->setLogger($logger);

// Publish messages forever...
$payloadCounter = 1;

while (true) {
    $payload = (object) [
        'counter' => $payloadCounter++
    ];

    $publisher->publish($topic, $payload);

    usleep($sleep * 1000000);
}
